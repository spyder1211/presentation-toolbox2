# Dify ナレッジベース設定ガイド（都留市HP対応）

## はじめに
本ガイドは、都留市HPから構造化したナレッジデータをDifyに取り込み、効果的なチャットボットを構築するための詳細手順書です。

---

## 1. 事前準備

### 必要な環境・アカウント
- Difyアカウント（Pro版推奨）
- 都留市HPナレッジデータ一式
- 管理者権限（ナレッジベース作成・編集用）

### データ確認事項
- ✅ ファイル総数: 12ファイル（コンテンツ9 + インデックス3）
- ✅ 総データサイズ: 約94KB
- ✅ 文字エンコーディング: UTF-8
- ✅ ファイル形式: Markdown (.md)

---

## 2. ナレッジベース作成・基本設定

### 2.1 新規ナレッジベース作成

1. **Difyダッシュボードにアクセス**
   - 「ナレッジベース」→「新規作成」をクリック

2. **基本情報設定**
   ```
   名前: 都留市HP市民相談チャットボット
   説明: 都留市の行政サービスに関する市民からの問い合わせに自動回答するナレッジベース
   言語: 日本語
   公開設定: プライベート（初期）
   ```

3. **アイコン・カバー画像**
   - 都留市ロゴまたは関連画像を設定（任意）

### 2.2 インデックス設定

1. **インデックスモード**
   ```
   モード: 高品質（High Quality）
   理由: 正確性重視の行政情報のため
   ```

2. **チャンク戦略**
   ```
   チャンクサイズ: 1000文字
   オーバーラップサイズ: 200文字
   分割方法: セマンティック分割
   ```

3. **エンベディングモデル**
   ```
   推奨: text-embedding-3-small（OpenAI）
   代替: multilingual-e5-large（多言語対応）
   ```

---

## 3. ファイルアップロード手順

### 3.1 推奨アップロード順序

#### Phase 1: 基幹ファイル（必須）
```
1. 00_INDEX.md
2. 01_極めて高優先度/ゴミ・リサイクル/ごみ出し検索ナビ.md
3. 01_極めて高優先度/ゴミ・リサイクル/ゴミ収集カレンダー.md
4. 01_極めて高優先度/防災・緊急情報/防災情報総合ガイド.md
5. 01_極めて高優先度/防災・緊急情報/避難所避難場所一覧.md
```

#### Phase 2: 手続き支援ファイル
```
6. 01_極めて高優先度/手続き案内/手続き検索ナビ総合ガイド.md
7. 01_極めて高優先度/手続き案内/転入手続きガイド.md
8. 01_極めて高優先度/手続き案内/転出手続きガイド.md
9. 02_高優先度/証明書・申請書/申請書ダウンロードガイド.md
```

#### Phase 3: 専門分野・完全版
```
10. 02_高優先度/子育て支援/子育て支援総合ガイド.md
11. 01_極めて高優先度/README.md
12. 02_高優先度/README.md
```

### 3.2 アップロード実行

1. **ファイル選択**
   - 「ファイルをアップロード」→「複数ファイル選択」
   - 上記順序でファイルを選択

2. **アップロード設定**
   ```
   ファイル形式: Markdown
   文字エンコーディング: UTF-8
   処理モード: 自動
   ```

3. **インデックス作成**
   - アップロード完了後、自動的にインデックス作成開始
   - 処理時間: 約5-10分（ファイルサイズに依存）

---

## 4. 詳細設定・最適化

### 4.1 検索設定

1. **検索戦略**
   ```
   検索方式: ベクトル検索 + フルテキスト検索（ハイブリッド）
   検索結果数: 5-8件
   類似度閾値: 0.7
   ```

2. **重み付け設定**
   ```
   極めて高優先度ファイル: 1.0倍
   高優先度ファイル: 0.8倍
   インデックスファイル: 0.6倍
   ```

### 4.2 キーワード・タグ設定

1. **主要キーワード**
   ```
   ゴミ, 分別, 収集, リサイクル, 粗大ゴミ
   防災, 災害, 避難, 緊急, ハザードマップ
   手続き, 転入, 転出, 住民票, 戸籍
   申請書, ダウンロード, 証明書
   子育て, 児童手当, 医療費助成, 保育園
   ```

2. **地名・固有名詞**
   ```
   都留市, 山梨県
   いきいきプラザ都留, 都留市役所
   A地区, B地区（ゴミ収集）
   ```

### 4.3 応答品質設定

1. **回答生成設定**
   ```
   最大回答文字数: 500文字
   引用表示: 有効
   信頼度表示: 有効
   ```

2. **フォールバック設定**
   ```
   未対応質問: 「詳細は都留市役所（0554-43-1111）にお問い合わせください」
   緊急事項: 緊急時は119・110番案内
   ```

---

## 5. テスト・検証プロセス

### 5.1 基本動作テスト

1. **単純な事実確認テスト**
   ```
   Q: 都留市役所の電話番号は？
   期待回答: 0554-43-1111
   
   Q: ゴミの収集日は？
   期待回答: 地区別情報の案内
   ```

2. **複合的な質問テスト**
   ```
   Q: 転入時にゴミの分別について知りたい
   期待回答: 転入手続きガイド + ゴミ収集カレンダーの情報
   ```

### 5.2 カテゴリー別テスト

1. **ゴミ・リサイクル**
   - 分別方法、収集日、粗大ゴミ処分
   - 2025年4月からの電池分別変更対応

2. **防災・緊急情報**  
   - 避難所の場所、ハザードマップ情報
   - 緊急時の連絡先案内

3. **手続き案内**
   - 転入・転出手続きの流れ
   - 必要書類・窓口案内

4. **子育て支援**
   - 児童手当、医療費助成の対象・申請方法
   - 保育園入園手続き

### 5.3 エラーケース対応テスト

1. **未対応質問**
   ```
   Q: 市長の名前は？
   期待回答: 適切なフォールバック応答
   ```

2. **曖昧な質問**
   ```
   Q: 手続きについて教えて
   期待回答: より具体的な質問への誘導
   ```

---

## 6. 運用設定・メンテナンス

### 6.1 定期更新プロセス

1. **月次更新（定期）**
   - 制度変更の確認
   - リンク先の有効性確認
   - 新着情報の反映

2. **緊急更新**
   - 災害時の避難所情報
   - 制度改正時の即座更新
   - システムメンテナンス情報

### 6.2 利用状況分析

1. **分析指標**
   ```
   - 質問カテゴリー別頻度
   - 回答精度率
   - 未回答質問の分析
   - 利用者満足度
   ```

2. **改善アクション**
   - 頻出未対応質問の追加
   - 回答精度向上のためのファイン調整
   - 新規カテゴリーの検討

### 6.3 セキュリティ・プライバシー

1. **アクセス制御**
   ```
   管理者: 都留市情報システム担当
   編集者: 各課担当者（限定）
   閲覧者: 制限なし（市民向け）
   ```

2. **データ保護**
   - 個人情報の非含有確認
   - 公開情報のみの利用
   - 定期的なセキュリティ監査

---

## 7. トラブルシューティング

### 7.1 よくある問題と対処法

1. **検索精度が低い場合**
   ```
   原因: チャンクサイズの不適合
   対処: チャンクサイズを800-1200文字で調整
   ```

2. **応答が遅い場合**
   ```
   原因: インデックスサイズ過大
   対処: 不要ファイルの除外、最適化実行
   ```

3. **文字化け・表示エラー**
   ```
   原因: エンコーディング問題
   対処: UTF-8 BOM無しで再アップロード
   ```

### 7.2 パフォーマンス最適化

1. **レスポンス速度向上**
   - 頻出質問への専用インデックス作成
   - キャッシュ機能の有効活用

2. **精度向上**
   - 同義語辞書の活用
   - ネガティブフィードバックの学習

---

## 8. チャットボット統合設定

### 8.1 API設定

1. **API Key生成**
   - Difyダッシュボード→「API」→「Key生成」
   - セキュリティレベル: 読み取り専用

2. **エンドポイント設定**
   ```
   Base URL: https://api.dify.ai/v1
   Headers: Authorization: Bearer [API_KEY]
   Content-Type: application/json
   ```

### 8.2 フロントエンド統合

1. **Webサイト埋め込み**
   - 都留市公式サイトへのチャットウィジェット埋め込み
   - レスポンシブデザイン対応

2. **モバイルアプリ対応**
   - スマートフォン向けUI最適化
   - プッシュ通知機能（緊急時）

---

## 9. 効果測定・KPI設定

### 9.1 測定指標

1. **利用統計**
   ```
   日次アクティブユーザー数
   質問カテゴリー別件数
   平均セッション時間
   ```

2. **品質指標**
   ```
   回答精度率: 85%以上目標
   応答時間: 3秒以内目標
   利用者満足度: 4.0/5.0以上目標
   ```

### 9.2 ROI測定

1. **コスト削減効果**
   ```
   窓口問い合わせ削減件数
   職員対応時間削減
   市民の利便性向上
   ```

2. **改善指標**
   ```
   月次: 未回答質問の分析・追加
   四半期: システム全体の見直し
   年次: 大幅なデータ更新・拡充
   ```

---

## 付録

### A. 緊急時対応プロトコル
- 災害時の情報更新手順
- システム障害時の代替案内方法
- 緊急連絡先の管理

### B. 関連リソース
- [Dify公式ドキュメント](https://docs.dify.ai/)
- [都留市HP利用規約](https://www.city.tsuru.yamanashi.jp/)
- プロジェクト関連資料一式

---

**作成日**: 2025-09-01  
**対象システム**: Dify Cloud/Self-hosted  
**更新頻度**: 四半期ごと、または重要アップデート時